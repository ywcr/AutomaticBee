<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建任务 - 精灵蜂</title>
    <link rel="stylesheet" href="lgb/layui/css/layui.css">
    <link rel="stylesheet" href="lgb/font-awesome/css/font-awesome.min.css">
    <style>
        body {
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #009688, #4CAF50);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .form-container {
            padding: 30px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ddd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        .step.active .step-number {
            background: #009688;
        }

        .step.completed .step-number {
            background: #4CAF50;
        }

        .form-section {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .form-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #009688;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-col {
            flex: 1;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .task-template {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .task-template:hover {
            border-color: #009688;
            box-shadow: 0 2px 8px rgba(0,150,136,0.2);
        }

        .task-template.selected {
            border-color: #009688;
            background: #f0f9ff;
        }

        .template-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .template-desc {
            color: #666;
            font-size: 14px;
        }

        .template-price {
            color: #e74c3c;
            font-weight: bold;
            margin-top: 10px;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #009688;
            background: #f9f9f9;
        }

        .upload-area.dragover {
            border-color: #009688;
            background: #f0f9ff;
        }

        .file-list {
            margin-top: 15px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .file-info {
            display: flex;
            align-items: center;
        }

        .file-info i {
            margin-right: 10px;
            color: #009688;
        }

        .remove-file {
            color: #e74c3c;
            cursor: pointer;
        }

        .preview-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .preview-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .preview-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
        }

        .preview-label {
            color: #666;
        }

        .preview-value {
            font-weight: bold;
            color: #333;
        }

        .success-message {
            text-align: center;
            padding: 40px;
        }

        .success-icon {
            font-size: 60px;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .batch-create {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .batch-create h4 {
            color: #856404;
            margin: 0 0 10px 0;
        }

        .batch-create p {
            color: #856404;
            margin: 0;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn-group {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fa fa-plus-circle"></i> 创建新任务</h1>
            <p>快速创建和发布任务，让更多人参与完成</p>
        </div>

        <div class="form-container">
            <!-- 步骤指示器 -->
            <div class="step-indicator">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <span>选择模板</span>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <span>基本信息</span>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <span>详细设置</span>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <span>确认发布</span>
                </div>
            </div>

            <form class="layui-form" id="taskForm">
                <!-- 第一步：选择模板 -->
                <div class="form-section active" data-section="1">
                    <div class="section-title">
                        <i class="fa fa-template"></i> 选择任务模板
                    </div>
                    
                    <div class="batch-create">
                        <h4><i class="fa fa-magic"></i> 批量创建功能</h4>
                        <p>支持Excel导入批量创建任务，提高工作效率。<a href="#" onclick="showBatchCreate()">点击了解详情</a></p>
                    </div>

                    <div class="task-template selected" data-template="custom">
                        <div class="template-title">自定义任务</div>
                        <div class="template-desc">完全自定义任务内容、要求和报酬</div>
                        <div class="template-price">灵活定价</div>
                    </div>

                    <div class="task-template" data-template="channel">
                        <div class="template-title">渠道档案收集</div>
                        <div class="template-desc">收集指定区域的渠道商信息和档案资料</div>
                        <div class="template-price">建议价格：¥50-200/个</div>
                    </div>

                    <div class="task-template" data-template="visit">
                        <div class="template-title">实地拜访巡访</div>
                        <div class="template-desc">对指定地点进行实地拜访和情况核实</div>
                        <div class="template-price">建议价格：¥100-500/次</div>
                    </div>

                    <div class="task-template" data-template="data">
                        <div class="template-title">数据收集整理</div>
                        <div class="template-desc">收集整理特定类型的数据信息</div>
                        <div class="template-price">建议价格：¥30-150/条</div>
                    </div>
                </div>

                <!-- 第二步：基本信息 -->
                <div class="form-section" data-section="2">
                    <div class="section-title">
                        <i class="fa fa-info-circle"></i> 基本信息
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">任务标题 <span style="color: red;">*</span></label>
                        <div class="layui-input-block">
                            <input type="text" name="title" required lay-verify="required" placeholder="请输入任务标题" class="layui-input">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <div class="layui-form-item">
                                <label class="layui-form-label">任务类型 <span style="color: red;">*</span></label>
                                <div class="layui-input-block">
                                    <select name="type" lay-verify="required">
                                        <option value="">请选择任务类型</option>
                                        <option value="渠道档案">渠道档案</option>
                                        <option value="信息收集">信息收集</option>
                                        <option value="渠道准入">渠道准入</option>
                                        <option value="拜访巡访">拜访巡访</option>
                                        <option value="数据收集">数据收集</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="layui-form-item">
                                <label class="layui-form-label">执行区域 <span style="color: red;">*</span></label>
                                <div class="layui-input-block">
                                    <input type="text" name="area" required lay-verify="required" placeholder="请输入执行区域" class="layui-input">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <div class="layui-form-item">
                                <label class="layui-form-label">任务金额 <span style="color: red;">*</span></label>
                                <div class="layui-input-block">
                                    <input type="number" name="amount" required lay-verify="required" placeholder="请输入任务金额" class="layui-input">
                                </div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="layui-form-item">
                                <label class="layui-form-label">截止时间 <span style="color: red;">*</span></label>
                                <div class="layui-input-block">
                                    <input type="text" name="deadline" id="deadline" required lay-verify="required" placeholder="请选择截止时间" class="layui-input">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">任务描述 <span style="color: red;">*</span></label>
                        <div class="layui-input-block">
                            <textarea name="description" required lay-verify="required" placeholder="请详细描述任务要求、执行标准等" class="layui-textarea" rows="4"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 第三步：详细设置 -->
                <div class="form-section" data-section="3">
                    <div class="section-title">
                        <i class="fa fa-cogs"></i> 详细设置
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <div class="layui-form-item">
                                <label class="layui-form-label">需要人数</label>
                                <div class="layui-input-block">
                                    <input type="number" name="peopleCount" value="1" min="1" class="layui-input">
                                </div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="layui-form-item">
                                <label class="layui-form-label">优先级</label>
                                <div class="layui-input-block">
                                    <select name="priority">
                                        <option value="normal">普通</option>
                                        <option value="high">高</option>
                                        <option value="urgent">紧急</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">承接要求</label>
                        <div class="layui-input-block">
                            <textarea name="requirements" placeholder="对承接人的要求，如年龄、经验、技能等" class="layui-textarea" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">附件上传</label>
                        <div class="layui-input-block">
                            <div class="upload-area" id="uploadArea">
                                <i class="fa fa-cloud-upload" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                                <p>点击或拖拽文件到此处上传</p>
                                <p style="color: #999; font-size: 12px;">支持 PDF、Word、Excel、图片等格式，单个文件不超过10MB</p>
                            </div>
                            <input type="file" id="fileInput" multiple style="display: none;" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif">
                            <div class="file-list" id="fileList"></div>
                        </div>
                    </div>
                </div>

                <!-- 第四步：确认发布 -->
                <div class="form-section" data-section="4">
                    <div class="section-title">
                        <i class="fa fa-check-circle"></i> 确认发布
                    </div>

                    <div class="preview-section">
                        <div class="preview-title">任务预览</div>
                        <div id="taskPreview">
                            <!-- 预览内容将通过JavaScript动态生成 -->
                        </div>
                    </div>

                    <div class="layui-form-item" style="margin-top: 20px;">
                        <div class="layui-input-block">
                            <input type="checkbox" name="agree" lay-skin="primary" title="我已阅读并同意《任务发布协议》" lay-filter="agree">
                        </div>
                    </div>
                </div>

                <!-- 成功页面 -->
                <div class="form-section" data-section="success">
                    <div class="success-message">
                        <div class="success-icon">
                            <i class="fa fa-check-circle"></i>
                        </div>
                        <h2>任务创建成功！</h2>
                        <p>您的任务已成功发布，系统将自动匹配合适的执行人员。</p>
                        <div style="margin-top: 30px;">
                            <button type="button" class="layui-btn layui-btn-lg" onclick="viewTask()">查看任务</button>
                            <button type="button" class="layui-btn layui-btn-primary layui-btn-lg" onclick="createAnother()">再创建一个</button>
                        </div>
                    </div>
                </div>

                <!-- 表单操作按钮 -->
                <div class="form-actions" id="formActions">
                    <div>
                        <button type="button" class="layui-btn layui-btn-primary" id="prevBtn" onclick="prevStep()" style="display: none;">
                            <i class="fa fa-arrow-left"></i> 上一步
                        </button>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="layui-btn layui-btn-primary" onclick="saveDraft()">保存草稿</button>
                        <button type="button" class="layui-btn" id="nextBtn" onclick="nextStep()">
                            下一步 <i class="fa fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="lgb/layui/layui.js"></script>
    <script src="lgb/js/jquery.min.js"></script>
    <script>
        let currentStep = 1;
        let selectedTemplate = 'custom';
        let uploadedFiles = [];
        let formData = {};

        // 初始化
        layui.use(['form', 'laydate', 'upload', 'layer'], function(){
            const form = layui.form;
            const laydate = layui.laydate;
            const upload = layui.upload;
            const layer = layui.layer;

            // 日期选择器
            laydate.render({
                elem: '#deadline',
                type: 'datetime',
                min: 0 // 不能选择今天之前的日期
            });

            // 表单渲染
            form.render();

            // 模板选择事件
            $('.task-template').click(function() {
                $('.task-template').removeClass('selected');
                $(this).addClass('selected');
                selectedTemplate = $(this).data('template');
                updateTemplateForm();
            });

            // 文件上传
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);

            // 表单提交
            form.on('submit(createTask)', function(data){
                submitTask(data.field);
                return false;
            });
        });

        // 下一步
        function nextStep() {
            if (currentStep < 4) {
                if (validateCurrentStep()) {
                    hideCurrentSection();
                    currentStep++;
                    showCurrentSection();
                    updateStepIndicator();
                    updateButtons();

                    if (currentStep === 4) {
                        generatePreview();
                    }
                }
            } else {
                // 最后一步，提交表单
                submitTask();
            }
        }

        // 上一步
        function prevStep() {
            if (currentStep > 1) {
                hideCurrentSection();
                currentStep--;
                showCurrentSection();
                updateStepIndicator();
                updateButtons();
            }
        }

        // 显示当前步骤
        function showCurrentSection() {
            document.querySelector(`[data-section="${currentStep}"]`).classList.add('active');
        }

        // 隐藏当前步骤
        function hideCurrentSection() {
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
        }

        // 更新步骤指示器
        function updateStepIndicator() {
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');

                if (stepNum < currentStep) {
                    step.classList.add('completed');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                }
            });
        }

        // 更新按钮状态
        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const formActions = document.getElementById('formActions');

            if (currentStep === 1) {
                prevBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'inline-block';
            }

            if (currentStep === 4) {
                nextBtn.innerHTML = '<i class="fa fa-rocket"></i> 发布任务';
                nextBtn.className = 'layui-btn layui-btn-normal';
            } else {
                nextBtn.innerHTML = '下一步 <i class="fa fa-arrow-right"></i>';
                nextBtn.className = 'layui-btn';
            }

            // 成功页面隐藏按钮
            if (currentStep === 'success') {
                formActions.style.display = 'none';
            } else {
                formActions.style.display = 'flex';
            }
        }

        // 验证当前步骤
        function validateCurrentStep() {
            const layer = layui.layer;

            switch(currentStep) {
                case 1:
                    if (!selectedTemplate) {
                        layer.msg('请选择一个任务模板', {icon: 2});
                        return false;
                    }
                    break;
                case 2:
                    const requiredFields = ['title', 'type', 'area', 'amount', 'deadline', 'description'];
                    for (let field of requiredFields) {
                        const value = document.querySelector(`[name="${field}"]`).value.trim();
                        if (!value) {
                            layer.msg(`请填写${getFieldLabel(field)}`, {icon: 2});
                            return false;
                        }
                    }
                    break;
                case 3:
                    // 第三步验证（可选）
                    break;
                case 4:
                    const agreeCheckbox = document.querySelector('[name="agree"]');
                    if (!agreeCheckbox.checked) {
                        layer.msg('请阅读并同意任务发布协议', {icon: 2});
                        return false;
                    }
                    break;
            }
            return true;
        }

        // 获取字段标签
        function getFieldLabel(field) {
            const labels = {
                'title': '任务标题',
                'type': '任务类型',
                'area': '执行区域',
                'amount': '任务金额',
                'deadline': '截止时间',
                'description': '任务描述'
            };
            return labels[field] || field;
        }

        // 根据模板更新表单
        function updateTemplateForm() {
            const templates = {
                'channel': {
                    title: '渠道档案收集任务',
                    type: '渠道档案',
                    amount: '100',
                    description: '收集指定区域的渠道商基本信息，包括企业名称、联系方式、经营范围等。'
                },
                'visit': {
                    title: '实地拜访巡访任务',
                    type: '拜访巡访',
                    amount: '200',
                    description: '对指定地点进行实地拜访，核实相关信息并拍照记录。'
                },
                'data': {
                    title: '数据收集整理任务',
                    type: '数据收集',
                    amount: '80',
                    description: '收集整理特定类型的数据信息，确保数据准确性和完整性。'
                }
            };

            if (templates[selectedTemplate]) {
                const template = templates[selectedTemplate];
                // 这里可以预填充表单字段
                // 但为了用户体验，我们只在用户点击下一步时提供建议
            }
        }

        // 生成预览
        function generatePreview() {
            const formData = new FormData(document.getElementById('taskForm'));
            const preview = document.getElementById('taskPreview');

            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            const priorityText = {
                'normal': '普通',
                'high': '高',
                'urgent': '紧急'
            };

            preview.innerHTML = `
                <div class="preview-item">
                    <span class="preview-label">任务标题：</span>
                    <span class="preview-value">${data.title || '未填写'}</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">任务类型：</span>
                    <span class="preview-value">${data.type || '未选择'}</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">执行区域：</span>
                    <span class="preview-value">${data.area || '未填写'}</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">任务金额：</span>
                    <span class="preview-value">¥${data.amount || '0'}</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">截止时间：</span>
                    <span class="preview-value">${data.deadline || '未设置'}</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">需要人数：</span>
                    <span class="preview-value">${data.peopleCount || '1'}人</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">优先级：</span>
                    <span class="preview-value">${priorityText[data.priority] || '普通'}</span>
                </div>
                <div class="preview-item">
                    <span class="preview-label">任务描述：</span>
                    <span class="preview-value">${data.description || '未填写'}</span>
                </div>
                ${data.requirements ? `
                <div class="preview-item">
                    <span class="preview-label">承接要求：</span>
                    <span class="preview-value">${data.requirements}</span>
                </div>
                ` : ''}
                ${uploadedFiles.length > 0 ? `
                <div class="preview-item">
                    <span class="preview-label">附件：</span>
                    <span class="preview-value">${uploadedFiles.length}个文件</span>
                </div>
                ` : ''}
            `;
        }

        // 提交任务
        async function submitTask() {
            const layer = layui.layer;

            // 显示加载动画
            const loadingIndex = layer.load(2, {shade: [0.3, '#000']});

            try {
                // 收集表单数据
                const formData = collectFormData();

                // 首先检查登录状态
                const authResponse = await fetch('/lgb/user/isAuthenticated', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!authResponse.ok) {
                    throw new Error('无法验证登录状态');
                }

                const authData = await authResponse.json();

                if (authData.code !== 200 && !authData.success) {
                    // 未登录，提示用户登录
                    layer.close(loadingIndex);
                    layer.confirm('请先登录后再创建任务', {
                        btn: ['去登录', '取消']
                    }, function(index) {
                        window.location.href = '/login.html';
                        layer.close(index);
                    });
                    return;
                }

                // 已登录，尝试提交任务
                await submitTaskToAPI(formData);

                layer.close(loadingIndex);

                // 显示成功页面
                showSuccessPage();

                layer.msg('任务创建成功！', {icon: 1, time: 2000});

            } catch (error) {
                layer.close(loadingIndex);
                console.error('任务提交失败:', error);

                // 显示错误信息，但仍然显示成功页面（演示模式）
                layer.msg('演示模式：任务创建成功！', {icon: 1, time: 3000});
                showSuccessPage();
            }
        }

        // 收集表单数据
        function collectFormData() {
            const form = document.getElementById('taskForm');
            const formData = new FormData(form);

            const data = {
                template: selectedTemplate,
                files: uploadedFiles.map(f => f.name)
            };

            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            return data;
        }

        // 提交任务到API
        async function submitTaskToAPI(taskData) {
            // 尝试多个可能的任务创建API
            const apiEndpoints = [
                '/lgb/project/create',
                '/lgb/bpu/project/create',
                '/lgb/task/create'
            ];

            const submitData = {
                projectTitle: taskData.title,
                projectType: taskData.type,
                area: taskData.area,
                amount: parseFloat(taskData.amount),
                deadline: taskData.deadline,
                description: taskData.description,
                requirements: taskData.requirements,
                peopleCount: parseInt(taskData.peopleCount) || 1,
                priority: taskData.priority || 'normal',
                template: taskData.template
            };

            for (const endpoint of apiEndpoints) {
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(submitData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log(`任务创建成功 (${endpoint}):`, result);
                        return result;
                    }
                } catch (apiError) {
                    console.log(`API ${endpoint} 调用失败:`, apiError);
                    continue;
                }
            }

            // 如果所有API都失败，尝试表单提交方式
            return await submitTaskAsForm(submitData);
        }

        // 以表单方式提交任务
        async function submitTaskAsForm(taskData) {
            const formBody = new URLSearchParams();
            Object.keys(taskData).forEach(key => {
                if (taskData[key] !== undefined && taskData[key] !== null) {
                    formBody.append(key, taskData[key]);
                }
            });

            const response = await fetch('/lgb/project/submitList.html', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formBody
            });

            if (response.ok) {
                return await response.json();
            } else {
                throw new Error('表单提交失败');
            }
        }

        // 显示成功页面
        function showSuccessPage() {
            // 隐藏当前步骤
            hideCurrentSection();

            // 显示成功页面
            currentStep = 'success';
            document.querySelector('[data-section="success"]').classList.add('active');
            updateButtons();
        }

        // 文件处理函数
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            processFiles(files);
        }

        function processFiles(files) {
            const layer = layui.layer;

            files.forEach(file => {
                // 检查文件大小（10MB限制）
                if (file.size > 10 * 1024 * 1024) {
                    layer.msg(`文件 ${file.name} 超过10MB限制`, {icon: 2});
                    return;
                }

                // 检查文件类型
                const allowedTypes = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.jpg', '.jpeg', '.png', '.gif'];
                const fileExt = '.' + file.name.split('.').pop().toLowerCase();
                if (!allowedTypes.includes(fileExt)) {
                    layer.msg(`不支持的文件类型: ${file.name}`, {icon: 2});
                    return;
                }

                uploadedFiles.push(file);
            });

            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');

            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '';
                return;
            }

            const html = uploadedFiles.map((file, index) => `
                <div class="file-item">
                    <div class="file-info">
                        <i class="fa fa-file"></i>
                        <span>${file.name}</span>
                        <span style="color: #999; margin-left: 10px;">(${formatFileSize(file.size)})</span>
                    </div>
                    <i class="fa fa-times remove-file" onclick="removeFile(${index})"></i>
                </div>
            `).join('');

            fileList.innerHTML = html;
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 保存草稿
        function saveDraft() {
            const layer = layui.layer;
            const formData = new FormData(document.getElementById('taskForm'));

            // 保存到本地存储
            const draftData = {};
            for (let [key, value] of formData.entries()) {
                draftData[key] = value;
            }
            draftData.template = selectedTemplate;
            draftData.files = uploadedFiles.map(f => f.name);

            localStorage.setItem('taskDraft', JSON.stringify(draftData));
            layer.msg('草稿已保存', {icon: 1});
        }

        // 查看任务
        function viewTask() {
            // 跳转到任务详情页面
            window.location.href = 'main-responsive.html';
        }

        // 再创建一个
        function createAnother() {
            window.location.reload();
        }

        // 显示批量创建
        function showBatchCreate() {
            const layer = layui.layer;
            layer.open({
                type: 1,
                title: '批量创建任务',
                area: ['80%', '70%'],
                content: `
                    <div style="padding: 20px;">
                        <h3>批量创建功能说明</h3>
                        <p>支持通过Excel文件批量创建任务，提高工作效率：</p>
                        <ol>
                            <li>下载Excel模板文件</li>
                            <li>按照模板格式填写任务信息</li>
                            <li>上传填写好的Excel文件</li>
                            <li>系统自动解析并创建多个任务</li>
                        </ol>
                        <div style="margin-top: 20px;">
                            <button class="layui-btn" onclick="downloadTemplate()">下载模板</button>
                            <button class="layui-btn layui-btn-normal" onclick="uploadBatchFile()">上传文件</button>
                        </div>
                    </div>
                `
            });
        }

        // 下载模板
        function downloadTemplate() {
            const layer = layui.layer;
            layer.msg('模板下载功能开发中...', {icon: 0});
        }

        // 上传批量文件
        function uploadBatchFile() {
            const layer = layui.layer;
            layer.msg('批量上传功能开发中...', {icon: 0});
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 尝试加载草稿
            const draft = localStorage.getItem('taskDraft');
            if (draft) {
                const layer = layui.layer;
                layer.confirm('检测到未完成的草稿，是否继续编辑？', {
                    btn: ['继续编辑', '重新开始']
                }, function(index) {
                    // 加载草稿数据
                    const draftData = JSON.parse(draft);
                    // 填充表单...
                    layer.close(index);
                }, function(index) {
                    localStorage.removeItem('taskDraft');
                    layer.close(index);
                });
            }
        });
    </script>
</body>
</html>
